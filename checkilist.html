<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Face Moderna® - Validação</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print { .no-print { display: none !important; } body { background-color: white; } .page-break { page-break-before: always; } }
        .status-radio:checked + label.approve-label { background-color: #dcfce7; border-color: #166534; color: #166534; font-weight: bold; }
        .status-radio:checked + label.reject-label { background-color: #fee2e2; border-color: #991b1b; color: #991b1b; font-weight: bold; }
        #loadingOverlay { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); }
        input[type="text"], textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-20 sm:pb-0">

    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center p-4 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p id="loadingText" class="text-lg font-semibold text-slate-700">Processando...</p>
    </div>

    <!-- Header -->
    <div class="bg-slate-900 text-white shadow-lg sticky top-0 z-50 no-print">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 w-8 h-8 rounded flex items-center justify-center font-bold">F</div>
                <div><h1 class="text-base font-bold">Face Moderna®</h1></div>
            </div>
            <div class="flex gap-2" id="userActions">
                <button onclick="window.print()" class="w-8 h-8 bg-slate-700 rounded flex items-center justify-center"><i class="fas fa-print"></i></button>
                <button onclick="submitToCloud()" class="px-3 py-2 text-sm bg-blue-600 font-bold rounded shadow-lg active:scale-95 flex items-center gap-2">
                    <i class="fas fa-paper-plane"></i> <span>ENVIAR</span>
                </button>
            </div>
            <div class="hidden gap-2" id="adminActions">
                <span class="text-xs bg-red-900 text-red-100 px-2 py-1 rounded self-center font-bold">ADMIN</span>
                <button onclick="exitAdmin()" class="px-3 py-1 text-sm bg-slate-700 rounded">Sair</button>
            </div>
        </div>
    </div>

    <!-- Conteúdo -->
    <div class="max-w-6xl mx-auto p-3 sm:p-8 my-2 sm:my-6 bg-white min-h-screen sm:rounded-xl" id="mainContainer">
        <div id="viewChecklist">
            <div class="border-b pb-4 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Validação</h2>
                <div class="mt-2 flex items-center gap-2 text-sm" id="connectionStatus">
                    <i class="fas fa-circle-notch fa-spin text-blue-500"></i> <span class="text-slate-500">Iniciando sistema...</span>
                </div>
            </div>

            <form id="checklistForm"><div id="formContent" class="space-y-8"></div></form>

            <div class="mt-8 p-6 bg-slate-50 rounded-lg text-center pb-24">
                <button onclick="submitToCloud()" class="w-full sm:w-auto px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow-lg text-lg active:scale-95 flex items-center justify-center gap-3 mx-auto">
                    <i class="fas fa-check-circle"></i> FINALIZAR E ENVIAR
                </button>
            </div>
        </div>

        <!-- Admin -->
        <div id="viewAdmin" class="hidden">
            <div class="flex justify-between border-b pb-4 mb-4">
                <h2 class="text-xl font-bold">Respostas</h2>
                <button onclick="loadSubmissions()" class="text-blue-600 text-sm"><i class="fas fa-sync"></i> Atualizar</button>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="submissionsTableBody"></tbody></table></div>
            <div id="submissionDetail" class="hidden mt-6 p-4 border rounded bg-slate-50">
                <h3 class="font-bold mb-2">Detalhes</h3>
                <div id="detailContent" class="space-y-2"></div>
                <button onclick="document.getElementById('submissionDetail').classList.add('hidden')" class="mt-4 w-full py-2 bg-slate-200 rounded font-bold">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="max-w-6xl mx-auto py-6 text-center text-xs text-slate-400 no-print">
        <p>Face Moderna® &copy; 2025</p>
        <button onclick="toggleAdminLogin()" class="mt-4 px-4 py-2 border rounded-full">Área Admin</button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCCJe0qJrjSDtUiDm_sSSQMHjMk2kvosYE",
            authDomain: "gen-lang-client-0576190740.firebaseapp.com",
            projectId: "gen-lang-client-0576190740",
            storageBucket: "gen-lang-client-0576190740.firebasestorage.app",
            messagingSenderId: "204452081240",
            appId: "1:204452081240:web:152d6767306432916ca42d",
            measurementId: "G-8R69P0TC9D"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let checklistData = {};

        // Tentativa de Autenticação (mas não bloqueante)
        async function initAuth() {
            try {
                const userCredential = await signInAnonymously(auth);
                currentUser = userCredential.user;
                updateStatus(true, "Sistema Online (Autenticado)");
            } catch (error) {
                console.warn("Auth falhou, mas seguindo sem login:", error);
                // Gera ID falso se falhar, para não travar
                currentUser = { uid: "anonimo_" + Math.random().toString(36).substr(2, 9) };
                updateStatus(true, "Sistema Online (Modo Público)");
            }
        }
        
        function updateStatus(online, msg) {
            const el = document.getElementById('connectionStatus');
            if(online) el.innerHTML = `<i class="fas fa-wifi text-green-500"></i> <span class="text-green-700 font-bold">${msg}</span>`;
            else el.innerHTML = `<i class="fas fa-exclamation-triangle text-red-500"></i> <span class="text-red-700 font-bold">${msg}</span>`;
        }
        
        initAuth();

        // Dados
        const contentStructure = {
            headlines: ["Bem vindo a Era da Face Moderna.", "Mito Quebrado: Lesão Neural Zero.", "Taxa zero de lesão nervosa permanente em 212 casos.", "À prova de erros catastróficos. Literalmente.", "0% de lesão nervosa em 212 casos. Sua técnica consegue isso?", "Endoscópio: 2-5% lesão neural. Visão Direta: 0%. Você escolhe.", "3% complicações vs 12% (literatura endoscópica). Adivinha qual.", "3-4x MAIS SEGURO não é opinião. É DADO.", "Domine em 30 Casos, Não em 10 Anos.", "18 Anos [de experiência do Dr. Robério] em 30 Casos.", "A Solução Definitiva para Bioestimuladores.", "Juventude Restaurada em 7 Dias.", "Recuperação 50% mais rápida (retorno às atividades em 7 dias).", "Isso não é guerra. É MASSACRE.", "A Morte do Endomidface Tradicional.", "Segurança Máxima Garantida. Risco Quase Zero.", "Por que a Maestria Tátil Sistematizada Supera a Câmera Endoscópica.", "A Evolução da Cirurgia Facial: Uma História em Três Eras.", "Do Medo à Maestria: O Fim da Curva de Aprendizado Longa.", "Zero Lesão Nervosa Permanente em 212 Casos. Como é Possível?"],
            phrases: ["Não é sorte. É PROTOCOLO.", "Não 'garantimos'. ENTREGAMOS.", "Se houver resistência, você está no plano errado.", "Seu GPS Tátil para a Anatomia.", "Da Intuição à Prova Científica.", "Sistema estruturado = Mais EFICIENTE de aprender.", "Navegue com segurança em casos de fibrose pós-bioestimulador.", "Biofillers são seu pesadelo? Temos a solução documentada.", "Biofiller não é contraindicação. É onde Direct Vision® BRILHA.", "Ideal para o paciente que queixa a queda do terço médio.", "Seu paciente volta ao trabalho em 7 dias ou 21? Faça a conta.", "Menos trauma = Menos edema = Recuperação mais rápida.", "Não é exagero. É FÍSICA.", "O tato te diz na hora se você está no lugar certo ou não.", "Sunk Cost é passado. ROI é futuro.", "Velha Guarda (Nokia, Blackberry) Face Moderna® (iPhone).", "Aprenda UM SISTEMA do criador que resolveu TUDO.", "Respeite a história. Mas não viva nela.", "Face Moderna® não compete com Deep Plane. Ela o substitui.", "Não é mágica. É visão.", "3 bilhões de anos de evolução do olho humano são superiores a uma câmera de $80k.", "ROI emocional: IMPAGÁVEL."],
            quotes: ["É como separar páginas de livro molhado.", "Por que câmera de $80k perde para tato humano?", "'18 anos de experiência em 30 casos' não é mágica. É ENGENHARIA de ensino.", "Passei 20 anos quebrando paradigmas para que você não precise de 20 anos para dominar a cirurgia facial de elite.", "Excelência em cirurgia facial não deveria ser um segredo guardado por poucos. Nossa missão é socializá-la.", "Democratizar a segurança no plano profundo. Essa é a nossa verdadeira revolução.", "O objetivo não é criar seguidores. É formar mestres.", "Este método não foi criado para ser um 'dom'. Foi desenhado para ser um protocolo ensinável.", "Eu sei exatamente o que é sentir o medo paralisante do plano profundo. Este método é o mapa que eu gostaria de ter recebido no início da minha carreira.", "Meu papel não é te dar 'coragem'. É te dar um método tão seguro que a coragem se torna irrelevante.", "A evolução não pede permissão. Ela simplesmente acontece. E você escolhe: evoluir junto ou ficar para trás.", "O vídeo é como se você tivesse que cortar uma cenoura olhando para uma televisão. Não para a sua mão. O nosso método supera esse gap."],
            others: ["Navegação Segura no Plano Profundo em Áreas de Alto Risco.", "A orientação é feita pela palpação de cinco marcos ósseos-chave.", "Por Que a Maestria Tátil Sistematizada Supera a Câmera Endoscópica e Liberta o Cirurgião.", "A maestria não é sobre não ter dúvidas. É sobre ter um sistema que te dá as respostas certas quando elas aparecem.", "Você não está comprando um curso. Você está comprando 18 anos de noites mal dormidas, obsessão por detalhes e mais de 1.500 casos resolvidos.", "Não estamos comparando técnicas. Estamos comparando um sistema integrado contra um conjunto de ferramentas fragmentadas.", "Perguntar se a Visão Direta é 'melhor' que o endoscópio é como perguntar se o iPhone é um 'Nokia melhor'. Não é uma melhora. É uma nova categoria.", "A era das soluções isoladas para a face acabou. O futuro pertence aos sistemas que entregam resultados globais.", "Enquanto outros vendem o mapa de uma cidade, nós entregamos o GPS que funciona no mundo inteiro.", "Se a pessoa falar assim: 'eu só opero com anestesia local'. Pronto, exclui todo mundo. Todos vão perder de mim.", "O endomidface endoscópico foi revolucionário... nos anos 90.", "Aceitar complicações 'inerentes à técnica' não é mais aceitável quando existe alternativa sem complicações.", "A diferença entre boa medicina e excelência: Boa medicina usa o que sempre funcionou. Excelência usa o que funciona MELHOR.", "Se você ainda depende de uma torre endoscópica para operar midface em 2025... seus pacientes merecem saber que existe outra forma.", "Não é sobre desrespeitar o passado. É sobre não ficar preso nele.", "30 anos atrás, endomidface era vanguarda. Hoje, é histórico.", "Técnicas dos anos 90 para pacientes dos anos 2020? Não faz sentido.", "O que era impossível sem endoscópio em 1995 é rotineiro por visão direta em 2025.", "Bem vindo a Era da Face Moderna: uma nova escola de pensamento, desenhada para os desafios da face contemporânea.", "Aqui, formamos a próxima geração de cirurgiões na metodologia que transformou a especialidade.", "DADOS: Taxa de Lesão Nervosa: 0% em 212 casos (Face Moderna) vs. 2-5% (Endoscópio).", "DADOS: Complicações Gerais: 3% vs. 12% (literatura endoscópica).", "DADOS: Recuperação: Retorno em 7 dias (Face Moderna) vs. 21 dias (Tradicional).", "DADOS: Tempo Cirúrgico: 1h30 - 3h (Face Moderna) vs. 4-8h (Endoscópico).", "OBJEÇÃO: 'Deep Plane é o padrão-ouro...' -> RESPOSTA: ERA o padrão-ouro em 2005.", "OBJEÇÃO: 'Visão direta não alcança o mesmo plano...' -> RESPOSTA: Mito. Alcançamos com mais segurança (GPS Tátil).", "OBJEÇÃO: 'Curva de aprendizado curta parece irreal.' -> RESPOSTA: Não é mágica, é Engenharia de Ensino.", "OBJEÇÃO: 'Já investi R$ 80k em equipamento.' -> RESPOSTA: Sunk Cost Fallacy. Olhe para o ROI futuro.", "ESTRATÉGIA: Reconhecer o passado com respeito, Educar sobre limitações, Posicionar como evolução inevitável."]
        };
        const sectionTitles = {headlines: "1. Headlines", phrases: "2. Frases", quotes: "3. Citações", others: "4. Argumentos"};

        // Render
        const container = document.getElementById('formContent');
        for (const [key, items] of Object.entries(contentStructure)) {
            const section = document.createElement('div');
            section.className = "bg-white p-4 rounded-lg border shadow-sm";
            section.innerHTML = `<h3 class="text-lg font-bold sticky top-[60px] bg-white z-10 py-2 border-b">${sectionTitles[key]}</h3>`;
            items.forEach((text, index) => {
                const uid = `${key}_${index}`;
                section.innerHTML += `
                    <div class="py-6 border-b last:border-0">
                        <p class="mb-3 text-lg font-medium">"${text}"</p>
                        <div class="flex flex-col gap-3">
                            <div class="flex gap-2 w-full">
                                <input type="radio" id="a_${uid}" name="s_${uid}" value="approved" class="status-radio hidden" onchange="upd('${uid}','status','approved')">
                                <label for="a_${uid}" class="approve-label flex-1 px-4 py-3 rounded border text-center cursor-pointer select-none"><i class="fas fa-check"></i> Aprovar</label>
                                <input type="radio" id="r_${uid}" name="s_${uid}" value="rejected" class="status-radio hidden" onchange="upd('${uid}','status','rejected')">
                                <label for="r_${uid}" class="reject-label flex-1 px-4 py-3 rounded border text-center cursor-pointer select-none"><i class="fas fa-times"></i> Reprovar</label>
                            </div>
                            <input type="text" placeholder="Observação..." class="p-3 border rounded bg-slate-50 w-full" oninput="upd('${uid}','obs',this.value)">
                        </div>
                    </div>`;
            });
            container.appendChild(section);
        }

        window.upd = (id, field, value) => {
            if (!checklistData[id]) checklistData[id] = {};
            checklistData[id][field] = value;
            const [sec, idx] = id.split('_');
            checklistData[id].text = contentStructure[sec][parseInt(idx)];
        };

        window.submitToCloud = async () => {
            const total = Object.keys(checklistData).length;
            if (total === 0) return alert('Por favor, responda pelo menos um item antes de enviar.');
            
            if(!confirm(`Enviar ${total} respostas?`)) return;

            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                // Tenta enviar mesmo que currentUser seja nulo (cria um user fake se precisar)
                const uid = currentUser ? currentUser.uid : 'user_desconhecido_' + Date.now();
                
                await addDoc(collection(db, "checklist_submissions"), {
                    submittedAt: Timestamp.now(),
                    userId: uid,
                    answers: checklistData,
                    stats: {
                        approved: Object.values(checklistData).filter(i => i.status === 'approved').length,
                        rejected: Object.values(checklistData).filter(i => i.status === 'rejected').length,
                        total: total
                    }
                });
                
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert("SUCESSO! ✅\n\nAs respostas foram salvas no banco de dados.");
                
            } catch (e) {
                console.error(e);
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert(`ERRO AO SALVAR ❌\n\nDetalhe do erro: ${e.message}\n\nTire um print e envie para o suporte.`);
            }
        };

        // Admin
        window.toggleAdminLogin = () => { if(prompt("Senha:") === "admin123") { document.getElementById('viewChecklist').classList.add('hidden'); document.getElementById('viewAdmin').classList.remove('hidden'); loadSubmissions(); }};
        window.exitAdmin = () => location.reload();
        
        window.loadSubmissions = async () => {
            const tbody = document.getElementById('submissionsTableBody');
            tbody.innerHTML = '<tr><td class="p-4 text-center">Carregando...</td></tr>';
            try {
                const snap = await getDocs(query(collection(db, "checklist_submissions"), orderBy("submittedAt", "desc")));
                tbody.innerHTML = snap.empty ? '<tr><td class="p-4 text-center">Sem dados.</td></tr>' : '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.submittedAt?.toDate().toLocaleString() || 'Data desc.';
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-3">
                                <div class="font-bold">${date}</div>
                                <div class="text-xs text-slate-500">Aprovados: <span class="text-green-600 font-bold">${d.stats?.approved || 0}</span></div>
                                <button class="text-blue-600 font-bold text-xs mt-1" onclick='showDet(${JSON.stringify(d.answers)})'>VER DETALHES</button>
                            </td>
                        </tr>`;
                });
            } catch(e) { tbody.innerHTML = `<tr><td class="p-4 text-red-500">Erro: ${e.message}</td></tr>`; }
        };

        window.showDet = (ans) => {
            const div = document.getElementById('detailContent');
            div.innerHTML = '';
            Object.values(ans).forEach(v => {
                div.innerHTML += `<div class="p-2 border rounded ${v.status==='approved'?'bg-green-50 border-green-200':'bg-red-50 border-red-200'}">
                    <div class="font-bold text-xs uppercase ${v.status==='approved'?'text-green-700':'text-red-700'}">${v.status==='approved'?'Aprovado':'Reprovado'}</div>
                    <div class="text-sm italic my-1">"${v.text}"</div>
                    ${v.obs ? `<div class="bg-white p-1 text-xs border">Obs: ${v.obs}</div>` : ''}
                </div>`;
            });
            document.getElementById('submissionDetail').classList.remove('hidden');
        };
    </script>
</body>
</html>
